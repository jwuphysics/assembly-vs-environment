# Assembly versus Environment
This project investigates the relative importance of halo assembly history versus the environment in determining galaxy properties.
Utilizing cosmological simulations (IllustrisTNG), we trace galaxy evolution and properties.
The data used includes both dark matter only and hydrodynamic simulations.
The goal is to gain insights into the key physical processes that shape galaxy formation and evolution.

## Data

The data for this project is sourced from the IllustrisTNG simulation suite. We primarily use snapshot 99, which corresponds to redshift z=0.

**Environment:** To study the environmental effects, we utilize subhalo catalogs derived from:
- IllustrisTNG TNG100-1 (hydrodynamic simulation)
- IllustrisTNG TNG100-1-Dark (dark matter only simulation)
We use the `FoF_subfind` algorithm to identify subhalos and their properties. For the hydrodynamic simulation data, we select halos with a total mass $M_{\rm halo} \geq 10^{10} M_{\odot}$ and exclude any subhalos with `SubhaloFlag != 0`. A similar mass cut is applied to the dark matter only simulation.

**Assembly History:** To reconstruct halo assembly histories, we use:
- IllustrisTNG TNG100-1-Dark merger trees (specifically `SubLink` catalogs).
We select halos with $M_{\rm halo} \geq 10^{10} M_{\odot}$ at z=0 to trace their merger histories.

## Code Structure

The primary codebase for this project is located in the `src/` directory. This directory contains Python scripts for data processing, model definition, and visualization.

Key Python files in `src/` include:
*   `data.py`: Handles loading, processing, and initial filtering of subhalo catalogs and merger trees from the IllustrisTNG simulations.
*   `loader.py`: Responsible for constructing graph-structured datasets (environmental graphs and merger tree graphs) compatible with PyTorch Geometric, using the processed data from `data.py`.
*   `model.py`: Contains the definitions of the Graph Neural Network (GNN) architectures used in the project, such as `EdgeInteractionGNN`, `SAGEGraphConvNet`, and `MultiSAGENet`.
*   `visualize.py`: Includes functions for creating visualizations, primarily for plotting merger trees.

The project relies on several key Python libraries and frameworks, including:
*   `astropy`
*   `h5py`
*   `illustris_python`
*   `matplotlib`
*   `networkx`
*   `numpy`
*   `pandas`
*   `scipy`
*   `torch`
*   `torch_geometric`

## Models

This project employs Graph Neural Networks (GNNs) to analyze the graph-structured data generated by `loader.py`. These models are defined in `model.py` and are designed to learn from the complex relationships within environmental graphs and merger trees.

The specific GNN architectures include:
*   `EdgeInteractionGNN`: A GNN that explicitly incorporates edge features in its message passing steps, allowing for detailed modeling of interactions between connected nodes (subhalos or progenitors).
*   `SAGEGraphConvNet`: A GNN based on the GraphSAGE architecture, which learns by sampling and aggregating features from a node's local neighborhood.
*   `MultiSAGENet`: A multi-layer version of the SAGEGraphConvNet, potentially allowing for learning more complex representations.

These models are applied to the environmental and merger tree graphs to predict galaxy properties and investigate the influence of assembly history and environment.

## Getting Started

This section provides guidance on setting up the project and running the code.

### Prerequisites/Dependencies

The project requires Python and a number of standard scientific computing libraries. Key dependencies include:
*   `numpy`
*   `pandas`
*   `scipy`
*   `matplotlib`
*   `h5py`
*   `astropy`
*   `networkx`
*   `torch`
*   `torch_geometric`

These can generally be installed using `pip` or `conda`. For example:
```bash
pip install numpy pandas scipy matplotlib h5py astropy networkx torch torch_geometric
```
Ensure you have a compatible version of PyTorch installed for your system, as PyTorch Geometric relies on it.

### Data Setup

A crucial step is to obtain the IllustrisTNG simulation data. This project expects the data to be located in a specific directory structure relative to the project root.
*   **Expected base path:** `illustris_data/TNG100-1/`
*   This path should contain the output files from the TNG100-1 simulation, including subhalo catalogs and merger trees (e.g., `SubLink` data).
*   For details on accessing and downloading IllustrisTNG data, please refer to the [IllustrisTNG data access website](https://www.tng-project.org/data/).

The scripts in `src/`, particularly `src/data.py`, are configured to load data from this path.

### Running the Code

The scripts within the `src/` directory are designed for different stages of the data processing and analysis pipeline:
*   `src/data.py`: This script is responsible for the initial loading of raw IllustrisTNG data (subhalo catalogs, merger trees), performing necessary processing, and applying initial filters.
*   `src/loader.py`: Takes the processed data from `data.py` and constructs graph-structured datasets. These datasets (environmental graphs and merger tree graphs) are formatted for use with PyTorch Geometric.
*   `src/model.py`: Contains the definitions of the GNN architectures (`EdgeInteractionGNN`, `SAGEGraphConvNet`, `MultiSAGENet`). These models are intended to be imported and used by other scripts for training and evaluation tasks.
*   `src/visualize.py`: Provides functions for creating visualizations, such as plotting merger trees, which can be useful for inspecting the data and model outputs.

There isn't a single main execution script. Users would typically import functions from or run these scripts sequentially, depending on their specific analysis goals:
1.  Process raw simulation data using functionalities from `src/data.py`.
2.  Generate graph datasets using `src/loader.py` with the processed data.
3.  Utilize the models from `src/model.py` for training, inference, or further analysis on the graph data.
4.  Employ `src/visualize.py` for inspecting data or results.
Refer to the individual scripts for more specific usage details.

## Visualization

The `src/visualize.py` script provides functions for creating visualizations related to the project's data, particularly focusing on merger trees.

### Merger Tree Plots

A key visualization capability is the plotting of dark matter halo merger trees. The primary function for this is `plot_merger_tree` within `src/visualize.py`.

These plots illustrate the hierarchical build-up of a selected dark matter halo over cosmic time. Each node in the tree represents a progenitor halo, and edges connect progenitors to their descendants. Nodes are typically colored or sized based on halo properties, such as mass or stellar mass, providing a visual representation of how halos assemble.

These visualizations are crucial for:
*   Understanding the assembly history component of the research.
*   Debugging data processing steps related to merger trees.
*   Qualitatively inspecting the features that the GNN models might learn.

### Usage

To generate these plots, users can import the `plot_merger_tree` function from `src/visualize.py`. This function typically requires:
*   A processed merger tree, often as a pandas DataFrame (e.g., obtained from `data.py`).
*   The ID of the main halo whose tree is to be plotted.
*   Optionally, parameters to control node coloring, sizing, and layout.

The `plot_merger_tree` function includes a `save_figname` parameter, allowing the generated plots to be saved to disk (e.g., as PDF or PNG files) for inclusion in presentations or publications.
